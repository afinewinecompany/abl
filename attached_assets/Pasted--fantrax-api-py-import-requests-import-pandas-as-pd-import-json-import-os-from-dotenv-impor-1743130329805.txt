# === fantrax_api.py ===
import requests
import pandas as pd
import json
import os
from dotenv import load_dotenv

load_dotenv()

class FantraxClient:
    def __init__(self, league_id):
        self.league_id = league_id
        self.auth_token = os.getenv("FANTRAX_TOKEN")
        self.base_url = "https://www.fantrax.com/fxpa/req/league"

    def get_live_scoring(self, scoring_period):
        url = f"{self.base_url}/liveScoring"
        headers = {
            "Authorization": f"Bearer {self.auth_token}",
            "Content-Type": "application/json",
        }
        payload = {
            "leagueId": self.league_id,
            "scoringPeriod": scoring_period
        }
        response = requests.post(url, json=payload, headers=headers)

        if response.status_code == 200:
            return response.json()
        else:
            raise Exception(f"Error fetching live scoring: {response.status_code}")

    def parse_matchups(self, data):
        matchups = []
        periods = data.get("liveScoringMatchups", [])
        for m in periods:
            matchup = {
                "matchupId": m["id"],
                "team1": m["home"]["team"]["name"],
                "team1Score": m["home"]["score"],
                "team2": m["away"]["team"]["name"],
                "team2Score": m["away"]["score"]
            }
            matchups.append(matchup)
        return pd.DataFrame(matchups)


# === selenium_login.py ===
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.keys import Keys
import time
import os
from dotenv import load_dotenv

load_dotenv()

def fantrax_login():
    options = Options()
    options.add_argument('--headless')
    options.add_argument('--no-sandbox')
    options.add_argument('--disable-dev-shm-usage')

    driver = webdriver.Chrome(options=options)
    driver.get("https://www.fantrax.com/fantasy/login")

    time.sleep(2)

    username = driver.find_element(By.ID, "loginUsername")
    password = driver.find_element(By.ID, "loginPassword")

    username.send_keys(os.getenv("FANTRAX_USERNAME"))
    password.send_keys(os.getenv("FANTRAX_PASSWORD"))
    password.send_keys(Keys.RETURN)

    time.sleep(3)

    # Extract token from local storage
    token = driver.execute_script("return window.localStorage.getItem('fx.token');")

    driver.quit()

    if token:
        with open(".env", "a") as f:
            f.write(f"\nFANTRAX_TOKEN={token}\n")
        print("‚úÖ Token saved to .env")
    else:
        print("‚ùå Login failed. No token found.")


# === scheduler.py ===
import time
import schedule
from fantrax_api import FantraxClient

LEAGUE_ID = "grx2lginm1v4p5jd"
SCORING_PERIOD = 1

client = FantraxClient(LEAGUE_ID)

def job():
    try:
        data = client.get_live_scoring(SCORING_PERIOD)
        df = client.parse_matchups(data)
        df.to_csv("data/live_matchups.csv", index=False)
        print("‚úÖ Matchups updated")
    except Exception as e:
        print(f"‚ùå Error: {e}")

schedule.every(5).minutes.do(job)

print("üì° Fantrax Live Scoring Scheduler Running...")
while True:
    schedule.run_pending()
    time.sleep(1)


# === streamlit_app.py ===
import streamlit as st
import pandas as pd
import os

st.set_page_config(page_title="Fantrax Live Scoring", layout="wide")

st.title("üèÜ Fantrax Live Matchups")

if st.button("üîÑ Refresh Data"):
    os.system("python scheduler.py &")

try:
    df = pd.read_csv("data/live_matchups.csv")
    st.dataframe(df.style.format({
        "team1Score": "{:.1f}",
        "team2Score": "{:.1f}"
    }))
except FileNotFoundError:
    st.warning("No data yet. Please wait for the first pull.")
